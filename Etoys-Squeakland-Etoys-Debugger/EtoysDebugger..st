Class {
	#name : #EtoysDebugger,
	#superclass : #Object,
	#instVars : [
		'scriptEditor',
		'next',
		'timesToRepeat',
		'highlighter',
		'startingPosition'
	],
	#category : #'Etoys-Squeakland-Etoys-Debugger'
}

{ #category : #'class initialization' }
EtoysDebugger class >> initialize [
"
	self initialize
"
| buttonForm buttonPressedForm |
buttonForm := (Form
	extent: 30@30
	depth: 16
	fromArray: #( 0 0 0 0 0 26425 1731815225 1731815225 1731815225 1731788800 0 0 0 0 0 0 0 0 0 1731815225 1731821567 2147450879 2147450879 2147450879 2147444537 1731815225 0 0 0 0 0 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 0 0 0 26425 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 1731788800 0 0 0 0 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 0 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 0 26425 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 26425 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 98303 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 26425 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 98303 2147450879 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 65537 2147450879 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 65537 98303 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 65537 65537 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 65537 98303 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 65537 2147450879 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 98303 2147450879 2147450879 2147450879 2147450879 2147444537 1731821567 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 65537 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 26425 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 98303 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 26425 2147450879 2147450879 2147450879 2147450879 2147418113 98303 2147418113 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 0 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 0 0 0 0 26425 1731821567 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147444537 1731788800 0 0 0 0 0 26425 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 2147450879 1731788800 0 0 0 0 0 0 0 1731815225 1731821567 2147450879 2147450879 2147450879 2147444537 1731815225 0 0 0 0 0 0 0 0 0 26425 1731815225 1731815225 1731815225 1731788800 0 0 0 0 0)
	offset: 0@0).
buttonPressedForm := (Form
	extent: 30@30
	depth: 16
	fromArray: #( 0 0 0 0 0 19026 1246906962 1246906962 1246906962 1246887936 0 0 0 0 0 0 0 0 0 1246906962 1246911190 1523997398 1523997398 1523997398 1523993170 1246906962 0 0 0 0 0 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 0 0 0 19026 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 1246887936 0 0 0 0 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 0 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 0 19026 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 19026 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 88790 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 19026 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 88790 1523997398 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 65537 1523997398 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 65537 88790 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 65537 65537 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 65537 88790 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 65537 1523997398 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 88790 1523997398 1523997398 1523997398 1523997398 1523993170 1246911190 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 65537 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 19026 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 88790 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 19026 1523997398 1523997398 1523997398 1523997398 1523974145 88790 1523974145 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 0 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 0 0 0 0 19026 1246911190 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523993170 1246887936 0 0 0 0 0 19026 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1523997398 1246887936 0 0 0 0 0 0 0 1246906962 1246911190 1523997398 1523997398 1523997398 1523993170 1246906962 0 0 0 0 0 0 0 0 0 19026 1246906962 1246906962 1246906962 1246887936 0 0 0 0 0)
	offset: 0@0).
ScriptingSystem saveForm: buttonForm atKey: #StepMe.
ScriptingSystem saveForm: buttonPressedForm atKey: #StepMePressed
]

{ #category : #'instance creation' }
EtoysDebugger class >> on: aScriptEditorMorph [ 
	^ self basicNew initializeWith: aScriptEditorMorph
]

{ #category : #initialization }
EtoysDebugger >> delete [
	"If there is a highlighter associated with this debugger, delete it."

	highlighter ifNotNil:
		[:h | 
			h stopStepping.
			h delete]
]

{ #category : #evaluating }
EtoysDebugger >> evaluateNextTile [
      (scriptEditor isTextuallyCoded) ifTrue:[^ self inform: 'You can''t step through textually coded scripts.\Use a script''s tile-based representation instead.' withCRs translated].
	[next = (scriptEditor tiles at: 1 ifAbsent: [nil])
		ifTrue: ["We are about to evaluate the first tile"
			self updateStartingPosition].
	self trailMorph batchPenTrails
		ifTrue: [self evaluateNextTileWithBatchPenTrails]
		ifFalse: [next evaluateOn: self]]
		on: Error do: [:err || newNext |
			newNext := scriptEditor tiles at: 1 ifAbsent: [^ self].
			newNext = next
				ifTrue: [err pass]
				ifFalse: [next := newNext].
			self evaluateNextTile]


]

{ #category : #evaluating }
EtoysDebugger >> evaluateNextTileWithBatchPenTrails [
	| penDown |	
	penDown := self scriptedPlayer getPenDown.
	self scriptedPlayer setPenDown: false.
	[next evaluateOn: self]
		ensure: [self scriptedPlayer setPenDown: penDown].
	(penDown and: [next = (scriptEditor tiles at: 1 ifAbsent: [nil])])
		ifTrue: [| trailMorph tfm |
			"We've just evaluated the last tile, we should draw pen trail"
			trailMorph := self trailMorph.
			tfm := self scriptedPlayer costume owner transformFrom: trailMorph.
			trailMorph
				drawPenTrailFor: self scriptedPlayer costume
				from: (tfm localPointToGlobal: startingPosition)
				to: (tfm localPointToGlobal: self scriptedPlayerPosition)]
]

{ #category : #evaluating }
EtoysDebugger >> evaluatePhrase: tile [
	self highlight: tile.
	tile try.
	next := tile nextTile
]

{ #category : #evaluating }
EtoysDebugger >> evaluateRepeat: tile [
	self highlight: tile numberOfTimesToRepeatPart;
		timesToRepeat: tile calculateTimesToRepeat.
	next := tile nextTile
]

{ #category : #evaluating }
EtoysDebugger >> evaluateTest: test [
	| tile |
	test testPart tiles isEmpty
		ifTrue: [next := test yesPart tiles at: 1 ifAbsent: [test nextTile].
			next = test 
				ifTrue: [^ self]
				ifFalse: [^ self evaluateNextTile]].
	self highlight: test testPart.
	tile := test evaluateTestPart
		ifTrue: [test yesPart]
		ifFalse: [test noPart].
	next := tile tiles at: 1 ifAbsent: [test nextTile]
]

{ #category : #highlighting }
EtoysDebugger >> highlight: aMorph [
	"| rect |
	rect := BorderedMorph newBounds: aMorph bounds color: Color transparent.
	rect openInWorld.
	Project current world addAlarm: #delete
		withArguments: #()
		for: rect
		at: (Time millisecondClockValue + 200)."
	highlighter ifNotNil: [highlighter delete].
	highlighter := HighlightMorph on: aMorph.
	highlighter openInWorld
]

{ #category : #initialization }
EtoysDebugger >> initializeWith: aScriptEditorMorph [
	scriptEditor := aScriptEditorMorph.
	next := scriptEditor tiles at: 1 ifAbsent: nil.
	self updateStartingPosition;
		initialize
]

{ #category : #accessing }
EtoysDebugger >> scriptedPlayer [
	^ scriptEditor playerScripted
]

{ #category : #accessing }
EtoysDebugger >> scriptedPlayerPosition [
	^ self scriptedPlayer costume 
		ifNil: [0@0] 
		ifNotNil: [:m | m referencePosition]
]

{ #category : #accessing }
EtoysDebugger >> timesToRepeat [
	^ timesToRepeat
]

{ #category : #accessing }
EtoysDebugger >> timesToRepeat: aNumber [
	timesToRepeat := aNumber
]

{ #category : #accessing }
EtoysDebugger >> trailMorph [
	^ self scriptedPlayer costume ifNil: [Project current world] ifNotNil: [:m | m trailMorph]
]

{ #category : #initialization }
EtoysDebugger >> updateStartingPosition [
	startingPosition := self scriptedPlayerPosition
]
